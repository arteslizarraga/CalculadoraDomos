<!DOCTYPE HTML>
<html>
	<head> 
		<meta charset="UTF-8"> 
		<link rel="stylesheet" href="css/estilos.css">
		<link rel="stylesheet" href="css/cssmenu-negro.css?compile=false" />

		<script src="js/funcionesGenericas.js"></script>
		<script src="js/medidasDomoIcosaedro.js"></script>
		
	</head>
	<style>
		/* 1. Estilos para el contenedor: Flexbox con envoltura */
		#dibujar-triangulos {
			display: flex;
			flex-wrap: wrap; /* ¡Clave! Permite que los elementos pasen a la línea de abajo */
			justify-content: flex-start; /* Alinea los elementos a la izquierda */
			padding: 10px;
			border: 2px solid #ddd; /* Contenedor visual */
		}

		svg {
			/* El tamaño del SVG debe ser consistente con la lógica de dibujo */
			width: 350px; 
			height: 300px;
			border: 1px solid #ccc;
			margin: 10px; /* Separación entre triángulos */
		}
	
		/* Estilos para las letras */
		text {
			font-size: 18px;
			font-family: Arial, sans-serif;
			font-weight: bold;
		}
	</style>
<body>

<div id="cssmenu">	
	<ul>
		<li> <a href="index.html" class="link_opcion_seleccionada"> Icosaedro </a> </li> 
		<li> <a href="index_cuboctaedro.html"> Cuboctaedro </a> </li> 	
	</ul>	
</div>	

<div style="display: none" id="loading-spinner"></div> <!-- Imagen de carga de datos -->

<!--
<img name="img_dome_22_8v_0_5" src="Data/Geodesic_Dome/draw.cgi?n=22&amp;f=8v&amp;nox=1_2&amp;d=6.00&amp;hr=0.5" class="foto"><br><div class="desc">Geodesic 8V Icosahedron Dome (Human is 170cm/5'7")</div>
-->

<table border="1" width="100%">
	<tr style="background-color: #a89292; ">
		<td>  
			Frecuencia:
			<select id="cbx_frecuencia_domo" onchange="seleccionarDomo();">
				<option value="V4"> V4 </option>
				<option value="V6"> V6 </option>
				<option value="V7 10/21"> V7 10/21 </option>
				<option value="V7 11/21"> V7 11/21 </option>
				<option value="V8" selected> V8 </option>
			</select>
		</td>
		<td> 
			<table>
				<tr>
					<td> Diámetro del domo: </td>
					<td> 
						<input id="txt_diametro" value="13.00"> 
					</td>
					<td> 
						<select id="cbx_unidad_de_medida" onchange="seleccionarDomo();">
							<option value="centimetros"> centimetros </option>
							<option value="metros" selected> metros </option>
							<option value="pulgadas"> pulgadas </option>
						</select>
					</td>
					<td> <button type="button" onclick="seleccionarDomo();"> Calcular </button> </td>
				</tr>
				<tr>
					<td> Redondear resultados: </td>
					<td>  
						<select id="cbx_redondear_resultados" onchange="seleccionarDomo();">
							<option value="si"> si </option>
							<option value="no" selected> no </option>
						</select>
					</td>
					<td> </td>
					<td> </td>
				</tr>
			</table>			
		</td>
		<td></td>
	</tr>
	<tr>
		<td>
			<table id="tablaDomo" border="1"> 
				<thead> 
					<tr> 
						<th> Letra </th> 
						<th> Medidas </th> 
					</tr> 
				</thead> 
				<tbody></tbody> 
			</table> 

		</td>
		<td>
			<h4 id="descripcion_domo"></h4>

			<table>
				<tr>
					<td> Altura del domo: </td>
					<td> 
						<input type="text" id="alturaDomo" disabled> 
						<input type="text" id="porcentajeAlturaDiametro" disabled>
					</td>
				</tr>
				<tr>
					<td> Cantidad de triángulos: </td>
					<td> <input type="text" id="cantidadTriangulos" disabled> </td>
				</tr>
			</table>

			<img id="diagrama_construccion" onclick="abrirImagen(event)" style="width: 80%;" />
		</td>
		<td>
			<img id="imagen_resultado" onclick="abrirImagen(event)" />
		</td>
	</tr>
	<tr>
		<td></td>
		<td>
			<!-- <br/> <b> Total de tipos de triángulos: 0 </b> <br/><br/> -->
			<br/> <div id="totalTiposTriangulosDomo"></div> <br/><br/>

			<table id="tablaTiposTriangulosDomo" border="1" width="100%"> 
				<thead> 
					<tr> 
						<th> Identificador triángulo </th> 
						<th> Cantidad </th> 
						<th> Ángulos </th>
					</tr> 
				</thead> 
				<tbody></tbody> 
			</table> 
		</td>
		<td>
			<h4> Icosaedro (figura de base) </h4>
			<img src="imagenes/domo_icosaedro/icosaedro.gif" style="width: 20%;" />
		</td>
	</tr>
	<tr>
		<td colspan="3">
			<div id="dibujar-triangulos"></div>
		</td>
	</tr>
</table>

<br/><br/><br/>

</script>


<script>

let domoSeleccionado = null;

const calcularPorcentajeNumero = (numero, porcentaje) => {
	return (parseFloat(numero) * parseFloat(porcentaje)) / 100;
}

const abrirImagen = (evento) =>
{
	let medidasImagen = "location=yes,height=570,width=520,scrollbars=yes,status=yes";
	window.open(evento.target.src, "_blank", medidasImagen);
}

const callbackCambioImagenDomo = () => 
{
	//alert("callbackCambioImagenDomo");
	var imagen = document.querySelector("#diagrama_construccion");

	imagen.onload = () => {
		observarCambioTablaDomo.disconnect();
		//imagen.addEventListener("click", () => {  alert("se ha hecho click en la imagen");  });
		
		desplegarTablaCalculo(domoSeleccionado);	
		dibujarTriangulos();
		ocultarLoadingSpinner();	
	};
};

const observarCambioTablaDomo = new MutationObserver(callbackCambioImagenDomo);

const desplegarTablaCalculo = (domoSeleccionado) =>
{
	let diametro = document.querySelector("#txt_diametro").value;
	let radio = diametro / 2;

	//===================================================>>>>>

	var tablaDomo = document.querySelector("#tablaDomo tbody"); 
	tablaDomo.innerHTML = "";   // Limpia la tabla 

	let redondearResultados = (document.querySelector("#cbx_redondear_resultados").value == "si") ? true : false;

	domoSeleccionado.medidas
	.sort((a, b) => b.letra.localeCompare(a.letra))
	//.reverse()
	.forEach(c=> 
	{
		let medidaCalculada = 0;

		var fila = tablaDomo.insertRow(0);
		fila.insertCell(0).innerHTML = c.letra; 

		if (redondearResultados) {
			medidaCalculada = (radio * c.factorCoordenada).toString().substring(0,5);
		}
		else {
			medidaCalculada = Math.round((radio * c.factorCoordenada) * 10000) / 10000;
		}

		fila.insertCell(1).innerHTML = medidaCalculada;
		c.medidaCalculada = medidaCalculada;  // 13-12-2025 => Esto se usará al dibujar los triángulos
	});

	//===================================================>>>>>

	document.querySelector("#totalTiposTriangulosDomo").innerHTML = `<b> Total de tipos de triángulos: ${domoSeleccionado.tiposTriangulos.length} </b>`;

	var tablaTiposTriangulosDomo = document.querySelector("#tablaTiposTriangulosDomo tbody"); 
	tablaTiposTriangulosDomo.innerHTML = "";   // Limpia la tabla 

	domoSeleccionado.tiposTriangulos.reverse().forEach(c=> 
	{
		var fila = tablaTiposTriangulosDomo.insertRow(0);
	
		fila.insertCell(0).innerHTML = c.identificador;
		fila.insertCell(1).innerHTML = c.cantidad;
		fila.insertCell(2).innerHTML = c.datosAngulos; 
	});

	//===================================================>>>>>

	var unidadDeMedida = document.querySelector("#cbx_unidad_de_medida").value;
	let alturaDomo = calcularPorcentajeNumero(diametro, domoSeleccionado.porcentajeAlturaDiametro); 

	document.querySelector("#descripcion_domo").innerHTML = domoSeleccionado.descripcion;
	document.querySelector("#alturaDomo").value = alturaDomo + " " + unidadDeMedida;   // Esta es la altura del domo
	
	document.querySelector("#porcentajeAlturaDiametro").value = `${domoSeleccionado.porcentajeAlturaDiametro}% del diámetro`;
	
	
	document.querySelector("#cantidadTriangulos").value = domoSeleccionado.cantidadTriangulos;    // Cantidad de triangulos

	//document.img_dome_22_8v_0_5.src = 'Data/Geodesic_Dome/draw.cgi?n=22&f=8v&nox=1_2&d='+diametro+'&hr=0.5';
}

const seleccionarDomo = (() => 
{	
	domoSeleccionado = medidasDomoIcosaedro.find(c=> c.nombre == document.querySelector("#cbx_frecuencia_domo").value);
	
	document.querySelector("#descripcion_domo").innerHTML = "";
	document.querySelector("#alturaDomo").value = "";
	document.querySelector("#cantidadTriangulos").value = "";

	mostrarLoadingSpinner(); 
	observarCambioTablaDomo.observe(document.body, { subtree: true, childList: true });

	document.querySelector("#diagrama_construccion").src = domoSeleccionado.imagenDiagramaConstruccion;
	document.querySelector("#imagen_resultado").src = domoSeleccionado.imagenResultado;
})

seleccionarDomo();

//==============================================================================>>>>>>>
//==============================================================================>>>>>>>
// 14-12-2025

const MEDIDA_H_NORMALIZADA = 1.3998; 
const LONGITUD_H_PX = 200; 
const ESCALA_BASE = LONGITUD_H_PX / MEDIDA_H_NORMALIZADA;

function dibujarTriangulos()
{
	var arregloDibujarTriangulos = [];
	// var arregloDibujarTriangulos = [{"querySelector":"I-H-I","primeraCara":{"letra":"I","medida":1.4081},"segundaCara":{"letra":"H","medida":1.3998},"terceraCara":{"letra":"I","medida":1.4081}},{"querySelector":"G-H-G","primeraCara":{"letra":"G","medida":1.3384},"segundaCara":{"letra":"H","medida":1.3998},"terceraCara":{"letra":"G","medida":1.3384}},{"querySelector":"D-F-G","primeraCara":{"letra":"D","medida":1.3183},"segundaCara":{"letra":"F","medida":1.2871},"terceraCara":{"letra":"G","medida":1.3384}},{"querySelector":"C-D-E","primeraCara":{"letra":"C","medida":1.1824},"segundaCara":{"letra":"D","medida":1.3183},"terceraCara":{"letra":"E","medida":1.218}},{"querySelector":"C-B-C","primeraCara":{"letra":"C","medida":1.1824},"segundaCara":{"letra":"B","medida":1.2381},"terceraCara":{"letra":"C","medida":1.1824}},{"querySelector":"A-B-A","primeraCara":{"letra":"A","medida":1.0567},"segundaCara":{"letra":"B","medida":1.2381},"terceraCara":{"letra":"A","medida":1.0567}}];

	domoSeleccionado.tiposTriangulos.forEach(tipo => 
	{
		var letras = tipo.identificador.split("-");
		var caras = [];

		letras.forEach(letra => 
		{
			var medida = domoSeleccionado.medidas.find(m => m.letra === letra).medidaCalculada;
			caras.push({ letra: letra, medida: medida });
		});

		arregloDibujarTriangulos.push({ 
			querySelector: tipo.identificador,
			primeraCara: caras[0], 
			segundaCara: caras[1], 
			terceraCara: caras[2] 
		});
	});

	document.querySelector("#dibujar-triangulos").innerHTML = arregloDibujarTriangulos.map(x => 
	{
		return `<svg id="${x.querySelector}"></svg>`; // El tamaño se define en CSS
	}).join("");

	arregloDibujarTriangulos.forEach(x => dibujarTriangulo(x));
}

function dibujarTriangulo(objeto) 
{
    const cara1 = objeto.primeraCara;
    const cara2 = objeto.segundaCara;
    const cara3 = objeto.terceraCara;

    let A, B, C;

    // Aplicar ESCALA_BASE a todas las medidas, excepto si es el lado "H"
    A = (cara1.letra === 'H') ? LONGITUD_H_PX : cara1.medida * ESCALA_BASE;
    B = (cara2.letra === 'H') ? LONGITUD_H_PX : cara2.medida * ESCALA_BASE;
    C = (cara3.letra === 'H') ? LONGITUD_H_PX : cara3.medida * ESCALA_BASE;

    let L1, L2, BASE;

    // Estrategia de Encaje
    if (cara2.letra === 'H') {
        BASE = B;
        L1 = A;
        L2 = C;
    } else {
        BASE = C;
        L1 = A;
        L2 = B;
    }

    const paddingX = 20;
    const paddingY = 270;

    const x1 = paddingX, y1 = paddingY;
    const x2 = x1 + BASE, y2 = y1;

    const h = (L1 * L1 - L2 * L2 + BASE * BASE) / (2 * BASE);
    const altura = Math.sqrt(L1 * L1 - h * h);

    const x3 = x1 + h;
    const y3 = y1 - altura;

    if (isNaN(altura) || altura <= 0) {
        const svg = document.getElementById(objeto.querySelector);
        svg.innerHTML = `<text x="50" y="50" fill="red">
            Error: Medidas no forman un triángulo válido.
        </text>`;
        return;
    }

    const cx = (x1 + x2 + x3) / 3;
    const cy = (y1 + y2 + y3) / 3;

    function letraEnLado(xa, ya, xb, yb, texto) {
        const mx = (xa + xb) / 2;
        const my = (ya + yb) / 2;
        const factor = 0.2;
        const lx = mx + (cx - mx) * factor;
        const ly = my + (cy - my) * factor;
        return `<text x="${lx}" y="${ly}"
            text-anchor="middle"
            alignment-baseline="middle">${texto}</text>`;
    }

    let caraBase_Lado, caraL1_Lado, caraL2_Lado;

    if (cara2.letra === 'H') {
        caraBase_Lado = cara2;
        caraL1_Lado = cara1;
        caraL2_Lado = cara3;
    } else {
        caraBase_Lado = cara3;
        caraL1_Lado = cara1;
        caraL2_Lado = cara2;
    }

    const svg = document.getElementById(objeto.querySelector);

    svg.innerHTML = `
        <polygon
            points="${x1},${y1} ${x2},${y2} ${x3},${y3}"
            fill="none"
            stroke="black"
            stroke-width="2"
        />
        ${letraEnLado(x1, y1, x3, y3, caraL1_Lado.letra)}
        ${letraEnLado(x2, y2, x3, y3, caraL2_Lado.letra)}
        ${letraEnLado(x1, y1, x2, y2, caraBase_Lado.letra)}
    `;
}

//=============================================================>>>>>
/*
(async () => {
	await (() => {
		console.log("has algo")
	})()
})()
.then(() => {
  console.log("terminó");
});
*/

//=============================================================>>>>>
/*
const probando = async () => 
{
	await new Promise((resolver, rechazar) => 
	{
		mostrarLoadingSpinner(); 	
		setTimeout(function() { resolver(); }, 700);
		//resolver(); // Esto forma parte del promise
	})
	.catch(() => {
		alert("Se encontró un error");
	})
	.then(() => {
		ocultarLoadingSpinner();
	});
}
*/
//=============================================================>>>>>

</script>

</body>
</html>

