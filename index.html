<!DOCTYPE HTML>
<html>
	<head> 
		<meta charset="UTF-8"> 
		<link rel="stylesheet" href="css/estilos.css">
		<link rel="stylesheet" href="css/cssmenu-negro.css?compile=false" />

		<script src="js/funcionesGenericas.js"></script>
		<script src="js/medidasDomoIcosaedro.js"></script>
		
	</head>
	<style>
		svg {
			border: 1px solid #ccc;
		}
		text {
			font-size: 18px;
			font-family: Arial, sans-serif;
			font-weight: bold;
		}

		/* Layout en grilla */
		#dibujar-triangulos {
			display: grid;
			grid-template-columns: repeat(auto-fill, 300px);
			gap: 16px;
		}
	</style>
<body>

<div id="cssmenu">	
	<ul>
		<li> <a href="index.html" class="link_opcion_seleccionada"> Icosaedro </a> </li> 
		<li> <a href="index_cuboctaedro.html"> Cuboctaedro </a> </li> 	
	</ul>	
</div>	

<div style="display: none" id="loading-spinner"></div> <!-- Imagen de carga de datos -->

<!--
<img name="img_dome_22_8v_0_5" src="Data/Geodesic_Dome/draw.cgi?n=22&amp;f=8v&amp;nox=1_2&amp;d=6.00&amp;hr=0.5" class="foto"><br><div class="desc">Geodesic 8V Icosahedron Dome (Human is 170cm/5'7")</div>
-->

<table border="1" width="100%">
	<tr style="background-color: #a89292; ">
		<td>  
			Frecuencia:
			<select id="cbx_frecuencia_domo" onchange="seleccionarDomo();">
				<option value="V4"> V4 </option>
				<option value="V6"> V6 </option>
				<option value="V7 10/21"> V7 10/21 </option>
				<option value="V7 11/21"> V7 11/21 </option>
				<option value="V8" selected> V8 </option>
			</select>
		</td>
		<td> 
			<table>
				<tr>
					<td> Diámetro del domo: </td>
					<td> 
						<input id="txt_diametro" value="13.00"> 
					</td>
					<td> 
						<select id="cbx_unidad_de_medida" onchange="seleccionarDomo();">
							<option value="centimetros"> centimetros </option>
							<option value="metros" selected> metros </option>
							<option value="pulgadas"> pulgadas </option>
						</select>
					</td>
					<td> <button type="button" onclick="seleccionarDomo();"> Calcular </button> </td>
				</tr>
				<tr>
					<td> Redondear resultados: </td>
					<td>  
						<select id="cbx_redondear_resultados" onchange="seleccionarDomo();">
							<option value="si"> si </option>
							<option value="no" selected> no </option>
						</select>
					</td>
					<td> </td>
					<td> </td>
				</tr>
			</table>			
		</td>
		<td></td>
	</tr>
	<tr>
		<td>
			<table id="tablaDomo" border="1"> 
				<thead> 
					<tr> 
						<th> Letra </th> 
						<th> Medidas </th> 
					</tr> 
				</thead> 
				<tbody></tbody> 
			</table> 

		</td>
		<td>
			<h4 id="descripcion_domo"></h4>

			<table>
				<tr>
					<td> Altura del domo: </td>
					<td> 
						<input type="text" id="alturaDomo" disabled> 
						<input type="text" id="porcentajeAlturaDiametro" disabled>
					</td>
				</tr>
				<tr>
					<td> Cantidad de triángulos: </td>
					<td> <input type="text" id="cantidadTriangulos" disabled> </td>
				</tr>
			</table>

			<img id="diagrama_construccion" onclick="abrirImagen(event)" style="width: 80%;" />
		</td>
		<td>
			<img id="imagen_resultado" onclick="abrirImagen(event)" />
		</td>
	</tr>
	<tr>
		<td></td>
		<td>
			<!-- <br/> <b> Total de tipos de triángulos: 0 </b> <br/><br/> -->
			<br/> <div id="totalTiposTriangulosDomo"></div> <br/><br/>

			<table id="tablaTiposTriangulosDomo" border="1" width="100%"> 
				<thead> 
					<tr> 
						<th> Identificador triángulo </th> 
						<th> Cantidad </th> 
						<th> Ángulos </th>
					</tr> 
				</thead> 
				<tbody></tbody> 
			</table> 
		</td>
		<td>
			<h4> Icosaedro (figura de base) </h4>
			<img src="imagenes/domo_icosaedro/icosaedro.gif" style="width: 20%;" />
		</td>
	</tr>
	<tr>
		<td colspan="3">
			<div id="dibujar-triangulos"></div>
		</td>
	</tr>
</table>

<br/><br/><br/>

</script>


<script>

let domoSeleccionado = null;

const calcularPorcentajeNumero = (numero, porcentaje) => {
	return (parseFloat(numero) * parseFloat(porcentaje)) / 100;
}

const abrirImagen = (evento) =>
{
	let medidasImagen = "location=yes,height=570,width=520,scrollbars=yes,status=yes";
	window.open(evento.target.src, "_blank", medidasImagen);
}

const callbackCambioImagenDomo = () => 
{
	//alert("callbackCambioImagenDomo");
	var imagen = document.querySelector("#diagrama_construccion");

	imagen.onload = () => {
		observarCambioTablaDomo.disconnect();
		//imagen.addEventListener("click", () => {  alert("se ha hecho click en la imagen");  });
		
		desplegarTablaCalculo(domoSeleccionado);	
		dibujarTriangulos();
		ocultarLoadingSpinner();	
	};
};

const observarCambioTablaDomo = new MutationObserver(callbackCambioImagenDomo);

const desplegarTablaCalculo = (domoSeleccionado) =>
{
	let diametro = document.querySelector("#txt_diametro").value;
	let radio = diametro / 2;

	//===================================================>>>>>

	var tablaDomo = document.querySelector("#tablaDomo tbody"); 
	tablaDomo.innerHTML = "";   // Limpia la tabla 

	let redondearResultados = (document.querySelector("#cbx_redondear_resultados").value == "si") ? true : false;

	domoSeleccionado.medidas
	.sort((a, b) => b.letra.localeCompare(a.letra))
	//.reverse()
	.forEach(c=> 
	{
		let medidaCalculada = 0;

		var fila = tablaDomo.insertRow(0);
		fila.insertCell(0).innerHTML = c.letra; 

		if (redondearResultados) {
			medidaCalculada = (radio * c.factorCoordenada).toString().substring(0,5);
		}
		else {
			medidaCalculada = Math.round((radio * c.factorCoordenada) * 10000) / 10000;
		}

		fila.insertCell(1).innerHTML = medidaCalculada;
		c.medidaCalculada = medidaCalculada;  // 13-12-2025 => Esto se usará al dibujar los triángulos
	});

	//===================================================>>>>>

	document.querySelector("#totalTiposTriangulosDomo").innerHTML = `<b> Total de tipos de triángulos: ${domoSeleccionado.tiposTriangulos.length} </b>`;

	var tablaTiposTriangulosDomo = document.querySelector("#tablaTiposTriangulosDomo tbody"); 
	tablaTiposTriangulosDomo.innerHTML = "";   // Limpia la tabla 

	domoSeleccionado.tiposTriangulos.reverse().forEach(c=> 
	{
		var fila = tablaTiposTriangulosDomo.insertRow(0);
	
		fila.insertCell(0).innerHTML = c.identificador;
		fila.insertCell(1).innerHTML = c.cantidad;
		fila.insertCell(2).innerHTML = c.datosAngulos; 
	});

	//===================================================>>>>>

	var unidadDeMedida = document.querySelector("#cbx_unidad_de_medida").value;
	let alturaDomo = calcularPorcentajeNumero(diametro, domoSeleccionado.porcentajeAlturaDiametro); 

	document.querySelector("#descripcion_domo").innerHTML = domoSeleccionado.descripcion;
	document.querySelector("#alturaDomo").value = alturaDomo + " " + unidadDeMedida;   // Esta es la altura del domo
	
	document.querySelector("#porcentajeAlturaDiametro").value = `${domoSeleccionado.porcentajeAlturaDiametro}% del diámetro`;
	
	
	document.querySelector("#cantidadTriangulos").value = domoSeleccionado.cantidadTriangulos;    // Cantidad de triangulos

	//document.img_dome_22_8v_0_5.src = 'Data/Geodesic_Dome/draw.cgi?n=22&f=8v&nox=1_2&d='+diametro+'&hr=0.5';
}

const seleccionarDomo = (() => 
{	
	domoSeleccionado = medidasDomoIcosaedro.find(c=> c.nombre == document.querySelector("#cbx_frecuencia_domo").value);
	
	document.querySelector("#descripcion_domo").innerHTML = "";
	document.querySelector("#alturaDomo").value = "";
	document.querySelector("#cantidadTriangulos").value = "";

	mostrarLoadingSpinner(); 
	observarCambioTablaDomo.observe(document.body, { subtree: true, childList: true });

	document.querySelector("#diagrama_construccion").src = domoSeleccionado.imagenDiagramaConstruccion;
	document.querySelector("#imagen_resultado").src = domoSeleccionado.imagenResultado;
})

seleccionarDomo();

function dibujarTriangulos()
{
	var arregloDibujarTriangulos = [];
	// var arregloDibujarTriangulos = [{"querySelector":"I-H-I","primeraCara":{"letra":"I","medida":1.4081},"segundaCara":{"letra":"H","medida":1.3998},"terceraCara":{"letra":"I","medida":1.4081}},{"querySelector":"G-H-G","primeraCara":{"letra":"G","medida":1.3384},"segundaCara":{"letra":"H","medida":1.3998},"terceraCara":{"letra":"G","medida":1.3384}},{"querySelector":"D-F-G","primeraCara":{"letra":"D","medida":1.3183},"segundaCara":{"letra":"F","medida":1.2871},"terceraCara":{"letra":"G","medida":1.3384}},{"querySelector":"C-D-E","primeraCara":{"letra":"C","medida":1.1824},"segundaCara":{"letra":"D","medida":1.3183},"terceraCara":{"letra":"E","medida":1.218}},{"querySelector":"C-B-C","primeraCara":{"letra":"C","medida":1.1824},"segundaCara":{"letra":"B","medida":1.2381},"terceraCara":{"letra":"C","medida":1.1824}},{"querySelector":"A-B-A","primeraCara":{"letra":"A","medida":1.0567},"segundaCara":{"letra":"B","medida":1.2381},"terceraCara":{"letra":"A","medida":1.0567}}];

	domoSeleccionado.tiposTriangulos.forEach(tipo => 
	{
		var letras = tipo.identificador.split("-");
		var caras = [];

		letras.forEach(letra => 
		{
			var medida = domoSeleccionado.medidas.find(m => m.letra === letra).medidaCalculada;
			caras.push({ letra: letra, medida: medida });
		});

		arregloDibujarTriangulos.push({ 
			querySelector: tipo.identificador,
			primeraCara: caras[0], 
			segundaCara: caras[1], 
			terceraCara: caras[2] 
		});
	});

	//console.log(arregloDibujarTriangulos);

	document.querySelector("#dibujar-triangulos").innerHTML =
	arregloDibujarTriangulos.map(x =>
		`<svg id="${x.querySelector}"></svg>`
	).join("");

	arregloDibujarTriangulos.forEach(x => dibujarTriangulo(x));
}

function dibujarTriangulo(data) 
{
  // 1. CONFIGURACIÓN GENERAL
  const SVG_SIZE = 300;
  const MARGIN = 30;
  const DRAW_AREA = SVG_SIZE - MARGIN * 2;

  const svg = document.getElementById(data.querySelector);
  svg.setAttribute("width", SVG_SIZE);
  svg.setAttribute("height", SVG_SIZE);

  // 2. LADOS REALES
  const sideA = data.primeraCara.medida;
  const sideB = data.segundaCara.medida;
  const sideC = data.terceraCara.medida;

  // 3. ESCALA (NORMALIZACIÓN)
  const maxSide = Math.max(sideA, sideB, sideC);
  const scale = DRAW_AREA / maxSide;

  const A = sideA * scale;
  const B = sideB * scale;
  const C = sideC * scale;

  // 4. GEOMETRÍA DEL TRIÁNGULO
  // Base: C
  const height = Math.sqrt(A * A - (C * C) / 4);

  // 5. POSICIÓN CENTRADA
  const offsetX = (SVG_SIZE - C) / 2;
  const offsetY = (SVG_SIZE + height) / 2;

  const p1 = { x: offsetX,        y: offsetY };
  const p2 = { x: offsetX + C,    y: offsetY };
  const p3 = { x: offsetX + C / 2,y: offsetY - height };

  // 6. CENTROIDE
  const center = {
    x: (p1.x + p2.x + p3.x) / 3,
    y: (p1.y + p2.y + p3.y) / 3
  };

  // 7. TEXTO HACIA ADENTRO
  function labelBetween(a, b, text) 
  {
    const mid = {
      x: (a.x + b.x) / 2,
      y: (a.y + b.y) / 2
    };

    const factor = 0.2;

    const pos = {
      x: mid.x + (center.x - mid.x) * factor,
      y: mid.y + (center.y - mid.y) * factor
    };

    return `
      <text x="${pos.x}" y="${pos.y}"
            text-anchor="middle"
            dominant-baseline="middle">
        ${text}
      </text>
    `;
  }

  // 8. DIBUJO FINAL
  svg.innerHTML = `
    <polygon
      points="${p1.x},${p1.y} ${p2.x},${p2.y} ${p3.x},${p3.y}"
      fill="none"
      stroke="black"
      stroke-width="1"
    />

    ${labelBetween(p1, p3, data.primeraCara.letra)}
    ${labelBetween(p2, p3, data.segundaCara.letra)}
    ${labelBetween(p1, p2, data.terceraCara.letra)}
  `;
}


//=============================================================>>>>>
/*
(async () => {
	await (() => {
		console.log("has algo")
	})()
})()
.then(() => {
  console.log("terminó");
});
*/

//=============================================================>>>>>
/*
const probando = async () => 
{
	await new Promise((resolver, rechazar) => 
	{
		mostrarLoadingSpinner(); 	
		setTimeout(function() { resolver(); }, 700);
		//resolver(); // Esto forma parte del promise
	})
	.catch(() => {
		alert("Se encontró un error");
	})
	.then(() => {
		ocultarLoadingSpinner();
	});
}
*/
//=============================================================>>>>>

</script>

</body>
</html>

